<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>flappy.one</title>
    
    <!-- React and Privy CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0a0f;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            cursor: crosshair;
        }
        
        #gameCanvas {
            display: block;
            background: #0d1117;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        /* Auth Button in Header */
        .auth-button-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 150;
        }
        
        .auth-button {
            padding: 10px 20px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 600;
            background: linear-gradient(180deg, #ffd700 0%, #e6b800 100%);
            border: 2px solid #b8930a;
            border-radius: 8px;
            color: #000;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .auth-button:hover {
            transform: scale(1.05);
            background: linear-gradient(180deg, #ffe433 0%, #f0c800 100%);
        }
        
        .auth-button.logged-in {
            background: linear-gradient(180deg, #00dd77 0%, #00bb66 100%);
            border-color: #009955;
        }
        
        .auth-button .wallet-icon {
            font-size: 16px;
        }
        
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: #1a1a1a;
            border: 2px solid #2a2a2a;
            border-radius: 8px;
            min-width: 200px;
            display: none;
            overflow: hidden;
        }
        
        .user-dropdown.active {
            display: block;
        }
        
        .user-dropdown-item {
            padding: 12px 16px;
            font-size: 13px;
            color: #fff;
            cursor: pointer;
            border-bottom: 1px solid #2a2a2a;
            transition: background 0.2s;
        }
        
        .user-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .user-dropdown-item:hover {
            background: #2a2a2a;
        }
        
        .user-dropdown-item.logout {
            color: #ff6666;
        }
        
        .wallet-address {
            font-family: 'Space Grotesk', monospace;
            font-size: 11px;
            color: #888;
        }
        
        .user-balance {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            color: #ffc800;
        }
        
        /* Privy Modal Overlay */
        .privy-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .privy-modal-overlay.active {
            display: flex;
        }
        
        .privy-modal {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 2px solid #2a2a2a;
        }
        
        .privy-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #666;
            font-size: 24px;
            cursor: pointer;
        }
        
        .privy-modal-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
        }
        
        .privy-modal h2 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 24px;
            color: #fff;
            margin-bottom: 8px;
        }
        
        .privy-modal p {
            color: #888;
            font-size: 14px;
            margin-bottom: 24px;
        }
        
        .privy-input {
            width: 100%;
            padding: 14px;
            font-size: 14px;
            background: #2a2a2a;
            border: 2px solid #3a3a3a;
            border-radius: 8px;
            color: #fff;
            margin-bottom: 12px;
        }
        
        .privy-input:focus {
            border-color: #ffc800;
            outline: none;
        }
        
        .privy-submit-btn {
            width: 100%;
            padding: 14px;
            font-size: 14px;
            font-weight: 600;
            background: linear-gradient(180deg, #ffd700 0%, #e6b800 100%);
            border: 2px solid #b8930a;
            border-radius: 8px;
            color: #000;
            cursor: pointer;
            margin-bottom: 16px;
        }
        
        .privy-submit-btn:hover {
            background: linear-gradient(180deg, #ffe433 0%, #f0c800 100%);
        }
        
        .privy-divider {
            display: flex;
            align-items: center;
            margin: 16px 0;
            color: #666;
            font-size: 12px;
        }
        
        .privy-divider::before,
        .privy-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #3a3a3a;
        }
        
        .privy-divider::before {
            margin-right: 12px;
        }
        
        .privy-divider::after {
            margin-left: 12px;
        }
        
        .privy-social-btn {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            font-weight: 500;
            background: #2a2a2a;
            border: 2px solid #3a3a3a;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        
        .privy-social-btn:hover {
            background: #3a3a3a;
            border-color: #4a4a4a;
        }
        
        .privy-social-btn img {
            width: 20px;
            height: 20px;
        }
        
        .privy-footer {
            margin-top: 20px;
            font-size: 11px;
            color: #666;
        }
        
        .privy-footer a {
            color: #ffc800;
            text-decoration: none;
        }
        
        /* Loading spinner */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #3a3a3a;
            border-top-color: #ffc800;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Main Menu Screen */
        #menuScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0d0d0d;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* Header */
        .menu-header {
            text-align: center;
            margin-bottom: 24px;
            animation: fadeIn 0.6s ease-out;
        }
        
        .game-logo {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 52px;
            font-weight: 700;
            color: #fff;
            text-shadow: 
                3px 3px 0 #2d8a2d,
                -1px -1px 0 #2d8a2d,
                1px -1px 0 #2d8a2d,
                -1px 1px 0 #2d8a2d,
                0 4px 8px rgba(0,0,0,0.3);
            letter-spacing: 2px;
        }
        
        .game-logo .dot {
            color: #ffc800;
        }
        
        .game-tagline {
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            color: #888;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-top: 6px;
            font-weight: 500;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Main content grid */
        .menu-grid {
            display: grid;
            grid-template-columns: 280px 380px 280px;
            grid-template-rows: 500px;
            gap: 16px;
            max-width: 1000px;
            width: 100%;
            animation: fadeIn 0.8s ease-out;
        }
        
        @media (max-width: 1000px) {
            .menu-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                max-width: 400px;
            }
        }
        
        .menu-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
            height: 100%;
        }
        
        .menu-card {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 18px;
            border: 2px solid #2a2a2a;
            position: relative;
            overflow: hidden;
        }
        
        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }
        
        .card-title-icon {
            font-size: 16px;
        }
        
        .live-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0, 200, 100, 0.15);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            color: #00ff88;
            font-weight: 600;
        }
        
        .live-dot {
            width: 6px;
            height: 6px;
            background: #00ff88;
            border-radius: 50%;
            animation: livePulse 1.5s infinite;
        }
        
        @keyframes livePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .styled-btn {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            border-radius: 6px;
            position: relative;
            border: 2px solid transparent;
        }
        
        .styled-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(0,0,0,0.3);
            border-radius: 0 0 4px 4px;
        }
        
        .styled-btn:hover {
            transform: translateY(-1px);
        }
        
        .styled-btn:active {
            transform: translateY(1px);
        }
        
        .styled-btn:active::after {
            height: 1px;
        }
        
        .btn-primary {
            background: linear-gradient(180deg, #ffd700 0%, #e6b800 100%);
            color: #000;
            border-color: #b8930a;
        }
        
        .btn-primary:hover {
            background: linear-gradient(180deg, #ffe433 0%, #f0c800 100%);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            color: #888;
            border-color: #3a3a3a;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(180deg, #333 0%, #222 100%);
            color: #fff;
        }
        
        .btn-secondary.active {
            background: linear-gradient(180deg, #2a4a6a 0%, #1a3a5a 100%);
            color: #4a9eff;
            border-color: #4a9eff;
        }
        
        .btn-green {
            background: linear-gradient(180deg, #00dd77 0%, #00bb66 100%);
            color: #000;
            border-color: #009955;
        }
        
        .btn-green:hover {
            background: linear-gradient(180deg, #00ff88 0%, #00dd77 100%);
        }
        
        .btn-purple {
            background: transparent;
            color: #a855f7;
            border-color: #a855f7;
        }
        
        .btn-purple:hover {
            background: rgba(168, 85, 247, 0.1);
        }
        
        .btn-purple::after {
            display: none;
        }
        
        /* Leaderboard Card */
        .leaderboard-card {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        
        .leaderboard-rank {
            font-size: 14px;
            color: #666;
            min-width: 24px;
            font-weight: 500;
        }
        
        .leaderboard-name {
            flex: 1;
            font-size: 14px;
            color: #fff;
            font-weight: 500;
        }
        
        .leaderboard-amount {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 14px;
            color: #ffc800;
            font-weight: 600;
        }
        
        .view-full-btn {
            width: 100%;
            padding: 12px;
            margin-top: auto;
            font-size: 13px;
        }
        
        /* Friends Card */
        .friends-card {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .friends-header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
            color: #666;
        }
        
        .friends-header-actions span {
            cursor: pointer;
        }
        
        .friends-header-actions span:hover {
            color: #fff;
        }
        
        .playing-badge {
            background: rgba(0, 200, 100, 0.15);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            color: #00ff88;
            font-weight: 600;
        }
        
        .friends-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #555;
            text-align: center;
        }
        
        .friends-empty-icon {
            font-size: 36px;
            margin-bottom: 8px;
            opacity: 0.5;
        }
        
        .friends-empty-text {
            font-size: 13px;
        }
        
        .add-friends-btn {
            width: 100%;
            padding: 12px;
            margin-top: auto;
            font-size: 13px;
        }
        
        /* Center Column */
        .center-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .username-row {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
        }
        
        .username-avatar {
            width: 44px;
            height: 44px;
            background: #2a2a2a;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: #ffc800;
            border: 2px solid #3a3a3a;
        }
        
        .username-input-wrapper {
            flex: 1;
            position: relative;
        }
        
        .username-input {
            width: 100%;
            height: 44px;
            padding: 0 40px 0 14px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            background: #2a2a2a;
            border: 2px solid #3a3a3a;
            border-radius: 6px;
            color: #fff;
            outline: none;
            transition: all 0.15s ease;
        }
        
        .username-input:focus {
            border-color: #ffc800;
        }
        
        .username-input::placeholder {
            color: #666;
        }
        
        .username-edit-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            background: #3a3a3a;
            border: none;
            border-radius: 4px;
            color: #888;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .username-edit-btn:hover {
            background: #4a4a4a;
            color: #fff;
        }
        
        .bet-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
        }
        
        .bet-btn {
            flex: 1;
            padding: 12px 8px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 16px;
            font-weight: 700;
        }
        
        .bet-btn.active {
            background: linear-gradient(180deg, #ffd700 0%, #e6b800 100%);
            color: #000;
            border-color: #b8930a;
        }
        
        .bet-btn:not(.active) {
            background: linear-gradient(180deg, #3a3a2a 0%, #2a2a1a 100%);
            color: #b8a000;
            border-color: #4a4a3a;
        }
        
        .join-game-btn {
            width: 100%;
            padding: 16px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: 1px;
        }
        
        .join-game-btn .play-icon {
            font-size: 14px;
        }
        
        .server-row {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .server-toggle {
            width: 80px;
            padding: 10px;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .browse-btn {
            flex: 1;
            padding: 10px;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .separator {
            height: 1px;
            background: linear-gradient(90deg, transparent, #3a3a3a, transparent);
            margin: 8px 0;
        }
        
        .cashouts-section {
            margin: 8px 0;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .cashout-mini-feed {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .cashout-mini-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 6px 10px;
            background: rgba(0, 255, 136, 0.05);
            border-radius: 4px;
        }
        
        .cashout-mini-item .icon {
            font-size: 14px;
        }
        
        .cashout-mini-item .name {
            color: #fff;
            font-weight: 500;
        }
        
        .cashout-mini-item .text {
            color: #666;
            font-size: 11px;
        }
        
        .cashout-mini-item .amount {
            color: #00ff88;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            margin-left: auto;
        }
        
        .stats-row {
            display: flex;
            gap: 20px;
            justify-content: center;
            padding: 12px 0;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 20px;
            font-weight: 700;
        }
        
        .stat-number.blue {
            color: #4a9eff;
        }
        
        .stat-number.gold {
            color: #ffc800;
        }
        
        .stat-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 2px;
        }
        
        .center-spacer {
            flex: 1;
        }
        
        .affiliate-btn {
            width: 100%;
            padding: 14px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        /* Wallet Card */
        .wallet-card {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .wallet-header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 11px;
            color: #666;
        }
        
        .wallet-header-actions span {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .wallet-header-actions span:hover {
            color: #fff;
        }
        
        .wallet-balance {
            text-align: center;
            margin: 16px 0;
        }
        
        .wallet-amount {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 36px;
            font-weight: 700;
            color: #fff;
        }
        
        .wallet-sol {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }
        
        .wallet-buttons {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }
        
        .wallet-btn {
            flex: 1;
            padding: 12px;
            font-size: 13px;
        }
        
        .wallet-not-connected {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            text-align: center;
            padding: 20px;
        }
        
        .wallet-not-connected-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        .wallet-not-connected-text {
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        .connect-wallet-btn {
            padding: 12px 24px;
            font-size: 14px;
        }
        
        /* Customize Card */
        .customize-card {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .customize-preview {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80px;
        }
        
        .customize-bird {
            width: 80px;
            height: 80px;
            image-rendering: pixelated;
        }
        
        .animated-bird {
            animation: birdBob 0.8s ease-in-out infinite;
        }
        
        @keyframes birdBob {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-8px) rotate(5deg); }
        }
        
        .change-appearance-btn {
            width: 100%;
            padding: 12px;
            font-size: 13px;
            margin-top: auto;
        }
        
        .controls-footer {
            margin-top: 20px;
            text-align: center;
            color: #555;
            font-size: 12px;
            animation: fadeIn 1s ease-out;
            font-weight: 500;
        }
        
        .controls-footer span {
            color: #ffc800;
            font-weight: 600;
        }
        
        /* Skin Modal */
        .skin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }
        
        .skin-modal.active {
            display: flex;
        }
        
        .skin-modal-content {
            background: #1a1a1a;
            border: 2px solid #2a2a2a;
            border-radius: 12px;
            padding: 24px;
            max-width: 420px;
            width: 90%;
        }
        
        .skin-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .skin-modal-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }
        
        .skin-modal-close {
            background: none;
            border: none;
            color: #666;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .skin-modal-close:hover {
            color: #fff;
        }
        
        .skin-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        .skin-option {
            aspect-ratio: 1;
            border: 2px solid #2a2a2a;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            background: #222;
        }
        
        .skin-option:hover {
            border-color: #4a4a4a;
            background: #2a2a2a;
        }
        
        .skin-option.selected {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }
        
        .skin-option img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
        }
        
        /* HUD styles - keeping from original but truncated for brevity */
        #hud {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            display: none;
        }
        
        .hud-top {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .stat-box {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 8px;
            padding: 8px 16px;
            text-align: center;
        }
        
        .stat-box.balance {
            border-color: rgba(255, 200, 0, 0.5);
        }
        
        .stat-box .stat-label {
            font-size: 9px;
            color: #6a7a8a;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .stat-box .stat-value {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 18px;
            color: #00ff88;
            font-weight: 700;
        }
        
        .stat-box.balance .stat-value {
            color: #ffc800;
        }
        
        .bars-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
        }
        
        .bar-wrapper {
            margin-bottom: 8px;
        }
        
        .bar-label {
            font-size: 9px;
            color: #6a7a8a;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        
        .bar-bg {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }
        
        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.15s ease;
        }
        
        .bar-fill.health {
            background: linear-gradient(90deg, #ff4444, #ff6666);
            box-shadow: 0 0 10px rgba(255, 100, 100, 0.5);
        }
        
        .bar-fill.boost {
            background: linear-gradient(90deg, #00c8ff, #00a0ff);
            box-shadow: 0 0 10px rgba(0, 200, 255, 0.5);
        }
        
        .bar-fill.boost.depleted {
            background: linear-gradient(90deg, #ff4444, #ff6666);
            animation: boostFlash 0.2s infinite;
        }
        
        @keyframes boostFlash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }
        
        .cashout-container {
            position: absolute;
            bottom: 95px;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: auto;
        }
        
        #cashoutButton {
            padding: 12px 40px;
            font-size: 14px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            background: linear-gradient(180deg, #ffd700 0%, #e6b800 100%);
            border: 2px solid #b8930a;
            border-radius: 8px;
            color: #000;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        #cashoutButton:hover {
            transform: scale(1.05);
        }
        
        #cashoutButton.holding {
            background: linear-gradient(180deg, #00ff88 0%, #00cc6a 100%);
            border-color: #009955;
            animation: pulse 0.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1.05); }
            50% { transform: scale(1.1); }
        }
        
        .cashout-hint {
            text-align: center;
            font-size: 10px;
            color: #666;
            margin-top: 6px;
        }
        
        .cashout-hint span {
            color: #ffc800;
        }
        
        .leaderboard {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            min-width: 160px;
        }
        
        .leaderboard-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 10px;
            color: #6a7a8a;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
        }
        
        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 12px;
        }
        
        .leaderboard-entry .leaderboard-name {
            color: #fff;
            max-width: 90px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .leaderboard-entry .leaderboard-score {
            color: #ffc800;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
        }
        
        .leaderboard-entry.self .leaderboard-name {
            color: #00ff88;
        }
        
        .minimap {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 130px;
            height: 130px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .minimap canvas {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        /* Canvas HUD replacements */
        .cashout-container,
        .leaderboard,
        .minimap,
        .bird-label {
            display: none !important;
        }
        
        /* Death screen */
        #deathScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 80;
        }
        
        .death-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 42px;
            font-weight: 700;
            color: #ff4444;
            text-shadow: 0 0 30px rgba(255, 68, 68, 0.5);
            margin-bottom: 12px;
        }
        
        .death-info {
            font-size: 16px;
            color: #aaa;
            margin-bottom: 25px;
        }
        
        .death-info span {
            color: #ff6666;
            font-weight: 700;
        }
        
        .death-buttons {
            display: flex;
            gap: 12px;
        }
        
        .death-btn {
            padding: 14px 35px;
            font-size: 14px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        #respawnButton, #playAgainButton {
            background: linear-gradient(180deg, #00ff88 0%, #00cc6a 100%);
            border: 2px solid #009955;
            color: #000;
        }
        
        #respawnButton:hover, #playAgainButton:hover {
            transform: scale(1.05);
        }
        
        #mainMenuButton, #cashoutMenuButton {
            background: #2a2a2a;
            border: 2px solid #3a3a3a;
            color: #fff;
        }
        
        #mainMenuButton:hover, #cashoutMenuButton:hover {
            background: #3a3a3a;
        }
        
        /* Cashout screen */
        #cashoutScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.65);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 80;
        }

        .cashout-panel {
            width: 420px;
            max-width: 92vw;
            background: #161616;
            border: 1px solid #2a2a2a;
            border-radius: 18px;
            padding: 26px 26px 22px;
            text-align: center;
            color: #fff;
            position: relative;
            box-shadow: 0 18px 50px rgba(0, 0, 0, 0.55);
        }

        .cashout-close {
            position: absolute;
            top: 14px;
            right: 14px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: #2a2a2a;
            color: #bdbdbd;
            font-size: 18px;
            cursor: pointer;
        }

        .cashout-badge {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            margin: 4px auto 10px;
            background: #1b1b1b;
            border: 2px solid #f0c323;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cashout-title {
            font-family: 'Inter', sans-serif;
            font-size: 26px;
            font-weight: 800;
            color: #f4c225;
            margin-bottom: 6px;
        }

        .cashout-subtitle {
            font-size: 12px;
            letter-spacing: 1px;
            color: #8a8a8a;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .cashout-amount {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 34px;
            font-weight: 700;
            color: #00e676;
            margin-bottom: 2px;
        }

        .cashout-amount-sol {
            font-size: 13px;
            color: #7e7e7e;
            margin-bottom: 14px;
        }

        .cashout-divider {
            height: 2px;
            background: #2a2a2a;
            border-radius: 999px;
            margin: 14px 0 12px;
        }

        .cashout-stats {
            display: grid;
            grid-template-columns: 1fr 1px 1fr;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .cashout-stat-sep {
            width: 1px;
            height: 48px;
            background: #2a2a2a;
            justify-self: center;
        }

        .cashout-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .cashout-stat-icon {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #232323;
        }

        .cashout-stat-icon--blue {
            background: #3d3dff;
        }

        .cashout-stat-icon--red {
            background: #ff2d2d;
        }

        .cashout-stat-value {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: #d9d9d9;
        }

        .cashout-stat-label {
            font-size: 11px;
            color: #7f7f7f;
        }

        .cashout-payout-bar {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #1f1f1f;
            border: 1px solid #2f2f2f;
            border-radius: 8px;
            font-size: 13px;
            color: #d7d7d7;
            margin-bottom: 14px;
        }

        .cashout-payout-usd {
            color: #f4c225;
            font-weight: 700;
        }

        .cashout-payout-sol {
            color: #d7d7d7;
        }

        .cashout-actions {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1fr;
            gap: 10px;
        }

        .cashout-btn {
            height: 44px;
            border-radius: 10px;
            border: 2px solid #3a3a3a;
            background: #242424;
            color: #d9d9d9;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
        }

        .cashout-btn--primary {
            background: #f4c225;
            border-color: #c59a16;
            color: #1b1b1b;
        }
        
        .kill-feed {
            position: absolute;
            top: 70px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .kill-entry {
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            color: #aaa;
            animation: killFade 4s ease-out forwards;
            border-left: 3px solid #ff4444;
        }
        
        .kill-entry .killer {
            color: #00c8ff;
        }
        
        .kill-entry .victim {
            color: #ff6666;
        }
        
        @keyframes killFade {
            0% { opacity: 1; transform: translateX(0); }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translateX(-20px); }
        }
        
        .connection-status {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: #6a7a8a;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #00ff88;
        }
        
        .status-dot.disconnected {
            background: #ff4444;
        }
        
        .pause-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 48px;
            font-weight: 700;
            color: #ffc800;
            text-shadow: 0 0 30px rgba(255, 200, 0, 0.5);
            z-index: 90;
            display: none;
            letter-spacing: 8px;
        }
        
        .pause-indicator.active {
            display: block;
        }
        
        .bird-sprite {
            position: fixed;
            pointer-events: none;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            transform-origin: center center;
            z-index: 60;
            will-change: transform;
        }
        
        .bird-label {
            position: fixed;
            pointer-events: none;
            text-align: center;
            z-index: 61;
            font-family: 'Inter', sans-serif;
        }
        
        .bird-label .name {
            font-size: 14px;
            font-weight: bold;
            text-shadow: 0 0 4px rgba(0,0,0,0.8), 0 0 2px rgba(0,0,0,1);
        }
        
        .bird-label .balance {
            font-size: 13px;
            font-weight: bold;
            font-family: 'Space Grotesk', sans-serif;
            color: #ffc800;
            text-shadow: 0 0 4px rgba(0,0,0,0.8), 0 0 2px rgba(0,0,0,1);
        }
        
        /* Login required message on play button */
        .login-required-hint {
            font-size: 11px;
            color: #ff6666;
            text-align: center;
            margin-top: -8px;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <!-- Auth Button (Top Right) -->
    <div class="auth-button-container" id="authContainer">
        <button class="auth-button" id="authButton">
            <span class="wallet-icon">üîê</span>
            <span id="authButtonText">Sign Up / Login</span>
        </button>
        <div class="user-dropdown" id="userDropdown">
            <div class="user-dropdown-item">
                <div style="color: #fff; font-weight: 600; margin-bottom: 4px;" id="userDisplayName">Loading...</div>
                <div class="wallet-address" id="userWalletAddress">...</div>
            </div>
            <div class="user-dropdown-item">
                <div style="color: #888; font-size: 11px;">Wallet Balance</div>
                <div class="user-balance" id="userWalletBalance">$0.00</div>
            </div>
            <div class="user-dropdown-item" id="copyAddressBtn">üìã Copy Wallet Address</div>
            <div class="user-dropdown-item" id="fundWalletBtn">üí≥ Add Funds</div>
            <div class="user-dropdown-item logout" id="logoutBtn">üö™ Logout</div>
        </div>
    </div>
    
    <!-- Privy Login Modal (Custom Implementation) -->
    <div class="privy-modal-overlay" id="privyModal">
        <div class="privy-modal">
            <button class="privy-modal-close" id="privyModalClose">&times;</button>
            
            <img src="/assets/sprites/birds/yellow/fly_1.png" class="privy-modal-logo animated-bird" alt="Flappy">
            
            <h2>Log in or sign up</h2>
            <p>Enter your email or connect with social</p>
            
            <input type="email" class="privy-input" id="privyEmail" placeholder="your@email.com">
            <button class="privy-submit-btn" id="privyEmailSubmit">Continue with Email</button>
            
            <div class="privy-divider">or</div>
            
            <button class="privy-social-btn" id="privyGoogleBtn">
                <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Continue with Google
            </button>
            
            <div class="privy-footer">
                By logging in I agree to the <a href="#">Terms</a> & <a href="#">Privacy Policy</a><br>
                Protected by <strong>privy</strong>
            </div>
        </div>
    </div>
    
    <!-- Email Code Modal -->
    <div class="privy-modal-overlay" id="emailCodeModal">
        <div class="privy-modal">
            <button class="privy-modal-close" id="emailCodeModalClose">&times;</button>
            
            <h2>Check your email</h2>
            <p>We sent a code to <span id="emailSentTo">your@email.com</span></p>
            
            <input type="text" class="privy-input" id="emailCodeInput" placeholder="Enter 6-digit code" maxlength="6">
            <button class="privy-submit-btn" id="emailCodeSubmit">Verify Code</button>
            
            <div class="privy-footer">
                Didn't receive? <a href="#" id="resendCode">Resend code</a>
            </div>
        </div>
    </div>
    
    <!-- Main Menu Screen -->
    <div id="menuScreen">
        <div class="menu-header">
            <div class="game-logo">FLAPPY<span class="dot">.</span>ONE</div>
            <div class="game-tagline">Skill-Based Betting</div>
        </div>
        
        <div class="menu-grid">
            <!-- Left Column -->
            <div class="menu-column">
                <div class="menu-card leaderboard-card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-title-icon">üèÜ</span>
                            Leaderboard
                        </div>
                        <div class="live-badge">
                            <div class="live-dot"></div>
                            Live
                        </div>
                    </div>
                    <div class="leaderboard-list">
                        <div class="leaderboard-item">
                            <span class="leaderboard-rank">1.</span>
                            <span class="leaderboard-name">Mr-1221z</span>
                            <span class="leaderboard-amount">$15,582.31</span>
                        </div>
                        <div class="leaderboard-item">
                            <span class="leaderboard-rank">2.</span>
                            <span class="leaderboard-name">glx_duolingo</span>
                            <span class="leaderboard-amount">$15,078.29</span>
                        </div>
                        <div class="leaderboard-item">
                            <span class="leaderboard-rank">3.</span>
                            <span class="leaderboard-name">pepiklovesdick</span>
                            <span class="leaderboard-amount">$14,989.11</span>
                        </div>
                    </div>
                    <button class="styled-btn btn-secondary view-full-btn">View Full Leaderboard</button>
                </div>
                
                <div class="menu-card friends-card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-title-icon">üë•</span>
                            Friends
                        </div>
                        <div class="friends-header-actions">
                            <span>‚Üª Refresh</span>
                            <span class="playing-badge">0 playing</span>
                        </div>
                    </div>
                    <div class="friends-empty">
                        <div class="friends-empty-icon">üë§</div>
                        <div class="friends-empty-text">No friends... add some!</div>
                    </div>
                    <button class="styled-btn btn-secondary add-friends-btn">Add Friends</button>
                </div>
            </div>
            
            <!-- Center Column -->
            <div class="menu-column">
                <div class="menu-card center-card">
                    <div class="username-row">
                        <div class="username-avatar" id="usernameAvatar">?</div>
                        <div class="username-input-wrapper">
                            <input type="text" class="username-input" id="usernameInput" placeholder="Set Username" maxlength="20">
                            <button class="username-edit-btn">‚úé</button>
                        </div>
                    </div>
                    
                    <div class="bet-buttons">
                        <button class="styled-btn bet-btn active" data-amount="1">$1</button>
                        <button class="styled-btn bet-btn" data-amount="5">$5</button>
                        <button class="styled-btn bet-btn" data-amount="20">$20</button>
                    </div>
                    
                    <button class="styled-btn btn-primary join-game-btn" id="playButton" disabled>
                        <span class="play-icon">‚ñ∑</span>
                        <span id="playButtonText">LOGIN TO PLAY</span>
                    </button>
                    <div class="login-required-hint" id="loginHint">üëÜ Sign up above to start playing</div>
                    
                    <div class="server-row">
                        <button class="styled-btn btn-secondary server-toggle" id="serverToggle">
                            <span>üåê</span>
                            <span id="serverRegionText">US</span>
                        </button>
                        <button class="styled-btn btn-secondary browse-btn">
                            <span>‚â°</span>
                            Browse Lobbies
                        </button>
                    </div>
                    
                    <div class="separator"></div>
                    
                    <div class="cashouts-section">
                        <div class="section-header">
                            <div class="section-title">
                                <span>üí∏</span>
                                Cashouts
                            </div>
                            <div class="live-badge" style="padding: 2px 8px; font-size: 10px;">
                                <div class="live-dot" style="width: 5px; height: 5px;"></div>
                                LIVE
                            </div>
                        </div>
                        <div class="cashout-mini-feed" id="liveCashoutFeed">
                            <div class="cashout-mini-item">
                                <span class="icon">üê§</span>
                                <span class="name">WingNinja</span>
                                <span class="text">cashed out</span>
                                <span class="amount">$38.72</span>
                            </div>
                            <div class="cashout-mini-item">
                                <span class="icon">üê§</span>
                                <span class="name">FeatherFury</span>
                                <span class="text">cashed out</span>
                                <span class="amount">$7.22</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="separator"></div>
                    
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-number blue" id="menuPlayersInGame">64</div>
                            <div class="stat-label">Players In Game</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number gold">$<span id="menuGlobalWinnings">1,145,044</span></div>
                            <div class="stat-label">Global Player Winnings</div>
                        </div>
                    </div>
                    
                    <div class="center-spacer"></div>
                    
                    <button class="styled-btn btn-primary affiliate-btn">
                        <span>üë•</span>
                        Manage Affiliate
                    </button>
                </div>
            </div>
            
            <!-- Right Column -->
            <div class="menu-column">
                <div class="menu-card wallet-card" id="walletCard">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-title-icon">üí∞</span>
                            Wallet
                        </div>
                    </div>
                    
                    <!-- Not Connected State -->
                    <div class="wallet-not-connected" id="walletNotConnected">
                        <div class="wallet-not-connected-icon">üîê</div>
                        <div class="wallet-not-connected-text">Connect wallet to deposit & play</div>
                        <button class="styled-btn btn-green connect-wallet-btn" id="connectWalletBtn">Connect Wallet</button>
                    </div>
                    
                    <!-- Connected State (hidden by default) -->
                    <div id="walletConnected" style="display: none; flex: 1; flex-direction: column;">
                        <div class="wallet-header-actions">
                            <span id="copyWalletBtn">üìã Copy</span>
                            <span id="refreshBalanceBtn">‚Üª Refresh</span>
                        </div>
                        <div class="wallet-balance">
                            <div class="wallet-amount">$<span id="menuWalletBalance">0.00</span></div>
                            <div class="wallet-sol"><span id="menuWalletSol">0.0000</span> SOL</div>
                        </div>
                        <div class="wallet-buttons" style="margin-top: auto;">
                            <button class="styled-btn btn-green wallet-btn" id="addFundsBtn">Add Funds</button>
                            <button class="styled-btn btn-purple wallet-btn" id="withdrawBtn">Withdraw</button>
                        </div>
                    </div>
                </div>
                
                <div class="menu-card customize-card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-title-icon">üé®</span>
                            Customize
                        </div>
                    </div>
                    <div class="customize-preview">
                        <img class="customize-bird animated-bird" id="skinPreviewImg" src="/assets/sprites/birds/yellow/fly_1.png" alt="Bird">
                    </div>
                    <button class="styled-btn btn-secondary change-appearance-btn" id="skinPreview">Change Appearance</button>
                </div>
            </div>
        </div>
        
        <div class="controls-footer">
            <span>MOUSE</span> steer ‚Ä¢ <span>LMB/SPACE</span> shoot ‚Ä¢ <span>SHIFT</span> boost ‚Ä¢ Hold <span>F</span> to cashout
        </div>
    </div>
    
    <!-- Skin Selection Modal -->
    <div class="skin-modal" id="skinModal">
        <div class="skin-modal-content">
            <div class="skin-modal-header">
                <span class="skin-modal-title">Choose Your Bird</span>
                <button class="skin-modal-close" id="skinModalClose">&times;</button>
            </div>
            <div class="skin-grid" id="skinGrid"></div>
        </div>
    </div>
    
    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>
    
    <!-- Bird sprites container -->
    <div id="birdContainer"></div>
    
    <!-- HUD -->
    <div id="hud">
        <div class="hud-top">
            <div class="stat-box">
                <div class="stat-label">Kills</div>
                <div class="stat-value" id="killsValue">0</div>
            </div>
            <div class="stat-box balance">
                <div class="stat-label">Balance</div>
                <div class="stat-value" id="balanceValue">$0.00</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Players</div>
                <div class="stat-value" id="playerCount">0</div>
            </div>
        </div>
        
        <div class="bars-container">
            <div class="bar-wrapper">
                <div class="bar-label">
                    <span>Health</span>
                    <span id="healthValue">100</span>
                </div>
                <div class="bar-bg">
                    <div class="bar-fill health" id="healthBar"></div>
                </div>
            </div>
            <div class="bar-wrapper">
                <div class="bar-label">
                    <span>Boost</span>
                    <span id="boostValue">100</span>
                </div>
                <div class="bar-bg">
                    <div class="bar-fill boost" id="boostBar"></div>
                </div>
            </div>
        </div>
        
        <div class="cashout-container">
            <button id="cashoutButton">CASHOUT $<span id="cashoutAmount">0.00</span></button>
            <div class="cashout-hint">Hold <span>F</span> to cash out</div>
        </div>
        
        <div class="leaderboard">
            <div class="leaderboard-title">Top Balances</div>
            <div id="leaderboardContent"></div>
        </div>
        
        <div class="minimap">
            <canvas id="minimapCanvas"></canvas>
        </div>
        
        <div class="kill-feed" id="killFeed"></div>
        
        <div class="connection-status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Connected</span>
        </div>
        
        <div class="pause-indicator" id="pauseIndicator">PAUSED</div>
    </div>
    
    <!-- Death Screen -->
    <div id="deathScreen">
        <div class="death-title">DESTROYED</div>
        <div class="death-info">Eliminated by <span id="killerName">Unknown</span></div>
        <div class="death-buttons">
            <button class="death-btn" id="respawnButton">Play Again ($<span id="respawnAmount">1.00</span>)</button>
            <button class="death-btn" id="mainMenuButton">Main Menu</button>
        </div>
    </div>
    
    <!-- Cashout Success Screen -->
    <div id="cashoutScreen">
        <div class="cashout-panel">
            <button class="cashout-close" id="cashoutCloseButton">x</button>
            <div class="cashout-badge">
                <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <circle cx="12" cy="10" r="5.5" stroke="#f4c225" stroke-width="2"/>
                    <path d="M8.5 14.5L7 21l5-3 5 3-1.5-6.5" stroke="#f4c225" stroke-width="2" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="cashout-title">Cashout Successful!</div>
            <div class="cashout-subtitle">AMOUNT RECEIVED</div>
            <div class="cashout-amount">$<span id="finalCashout">0.00</span></div>
            <div class="cashout-amount-sol"><span id="finalCashoutSol">0.000000</span> SOL</div>
            <div class="cashout-divider"></div>
            <div class="cashout-stats">
                <div class="cashout-stat">
                    <div class="cashout-stat-icon cashout-stat-icon--blue">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <circle cx="12" cy="12" r="9" stroke="#ffffff" stroke-width="2"/>
                            <path d="M12 7v5l3 3" stroke="#ffffff" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <div class="cashout-stat-value" id="cashoutTimeSurvived">0m 0s</div>
                    <div class="cashout-stat-label">Time Survived</div>
                </div>
                <div class="cashout-stat-sep"></div>
                <div class="cashout-stat">
                    <div class="cashout-stat-icon cashout-stat-icon--red">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M12 3l2.5 5 5.5.8-4 3.9 1 5.6-5-2.6-5 2.6 1-5.6-4-3.9 5.5-.8L12 3z" stroke="#ffffff" stroke-width="2" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="cashout-stat-value" id="cashoutEliminations">0</div>
                    <div class="cashout-stat-label">Eliminations</div>
                </div>
            </div>
            <div class="cashout-payout-bar">
                <span class="cashout-payout-usd">$<span id="finalCashoutMini">0.00</span></span>
                <span>/</span>
                <span class="cashout-payout-sol"><span id="finalCashoutMiniSol">0.000000</span> SOL</span>
            </div>
            <div class="cashout-actions">
                <button class="cashout-btn" id="cashoutSpectateButton">Spectate</button>
                <button class="cashout-btn cashout-btn--primary" id="playAgainButton">Play Again ($<span id="playAgainAmount">1.00</span>)</button>
                <button class="cashout-btn" id="cashoutMenuButton">Home</button>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================================================
        // PRIVY AUTHENTICATION MODULE
        // ============================================================================
        
        const PRIVY_APP_ID = 'cmjwxzn2b040sl90d2khc3xao';
        const BACKEND_URL = 'http://localhost:5000';  // Your Python backend
        
        // Auth state
        let authState = {
            isAuthenticated: false,
            user: null,
            accessToken: null,
            walletAddress: null,
            walletBalance: 0,
            solBalance: 0
        };
        
        // DOM Elements for auth
        const authButton = document.getElementById('authButton');
        const authButtonText = document.getElementById('authButtonText');
        const userDropdown = document.getElementById('userDropdown');
        const privyModal = document.getElementById('privyModal');
        const privyModalClose = document.getElementById('privyModalClose');
        const privyEmail = document.getElementById('privyEmail');
        const privyEmailSubmit = document.getElementById('privyEmailSubmit');
        const privyGoogleBtn = document.getElementById('privyGoogleBtn');
        const emailCodeModal = document.getElementById('emailCodeModal');
        const emailCodeModalClose = document.getElementById('emailCodeModalClose');
        const emailCodeInput = document.getElementById('emailCodeInput');
        const emailCodeSubmit = document.getElementById('emailCodeSubmit');
        const emailSentTo = document.getElementById('emailSentTo');
        const playButton = document.getElementById('playButton');
        const playButtonText = document.getElementById('playButtonText');
        const loginHint = document.getElementById('loginHint');
        const walletNotConnected = document.getElementById('walletNotConnected');
        const walletConnected = document.getElementById('walletConnected');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Initialize Privy (placeholder - actual integration requires their SDK)
        // For production, you'll load the Privy React SDK properly
        
        // ============================================================================
        // AUTH UI HANDLERS
        // ============================================================================
        
        authButton.addEventListener('click', () => {
            if (authState.isAuthenticated) {
                userDropdown.classList.toggle('active');
            } else {
                showPrivyModal();
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!authButton.contains(e.target) && !userDropdown.contains(e.target)) {
                userDropdown.classList.remove('active');
            }
        });
        
        privyModalClose.addEventListener('click', hidePrivyModal);
        privyModal.addEventListener('click', (e) => {
            if (e.target === privyModal) hidePrivyModal();
        });
        
        emailCodeModalClose.addEventListener('click', () => {
            emailCodeModal.classList.remove('active');
        });
        
        connectWalletBtn.addEventListener('click', showPrivyModal);
        
        logoutBtn.addEventListener('click', () => {
            logout();
            userDropdown.classList.remove('active');
        });
        
        function showPrivyModal() {
            privyModal.classList.add('active');
        }
        
        function hidePrivyModal() {
            privyModal.classList.remove('active');
        }
        
        // ============================================================================
        // PRIVY API INTEGRATION
        // ============================================================================
        
        // Email login flow
        privyEmailSubmit.addEventListener('click', async () => {
            const email = privyEmail.value.trim();
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email');
                return;
            }
            
            try {
                privyEmailSubmit.innerHTML = '<div class="loading-spinner"></div>';
                privyEmailSubmit.disabled = true;
                
                // Call Privy API to send OTP
                const response = await fetch(`https://auth.privy.io/api/v1/passwordless/init`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'privy-app-id': PRIVY_APP_ID
                    },
                    body: JSON.stringify({ email })
                });
                
                if (response.ok) {
                    emailSentTo.textContent = email;
                    hidePrivyModal();
                    emailCodeModal.classList.add('active');
                } else {
                    const error = await response.json();
                    alert('Failed to send code: ' + (error.message || 'Unknown error'));
                }
            } catch (err) {
                console.error('Email login error:', err);
                alert('Failed to send verification code. Please try again.');
            } finally {
                privyEmailSubmit.innerHTML = 'Continue with Email';
                privyEmailSubmit.disabled = false;
            }
        });
        
        // Verify OTP code
        emailCodeSubmit.addEventListener('click', async () => {
            const code = emailCodeInput.value.trim();
            if (code.length !== 6) {
                alert('Please enter the 6-digit code');
                return;
            }
            
            try {
                emailCodeSubmit.innerHTML = '<div class="loading-spinner"></div>';
                emailCodeSubmit.disabled = true;
                
                // Call Privy API to verify OTP and get access token
                const response = await fetch(`https://auth.privy.io/api/v1/passwordless/authenticate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'privy-app-id': PRIVY_APP_ID
                    },
                    body: JSON.stringify({
                        email: emailSentTo.textContent,
                        code: code
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    await handleAuthSuccess(data);
                    emailCodeModal.classList.remove('active');
                } else {
                    const error = await response.json();
                    alert('Invalid code: ' + (error.message || 'Please try again'));
                }
            } catch (err) {
                console.error('Code verification error:', err);
                alert('Failed to verify code. Please try again.');
            } finally {
                emailCodeSubmit.innerHTML = 'Verify Code';
                emailCodeSubmit.disabled = false;
            }
        });
        
        // Google OAuth login
        privyGoogleBtn.addEventListener('click', () => {
            // For production, use Privy's OAuth flow
            // This requires proper SDK integration
            
            // Redirect to Privy OAuth
            const redirectUri = encodeURIComponent(window.location.origin + '/auth/callback');
            const oauthUrl = `https://auth.privy.io/api/v1/oauth/authorize?` +
                `app_id=${PRIVY_APP_ID}&` +
                `provider=google&` +
                `redirect_uri=${redirectUri}`;
            
            window.location.href = oauthUrl;
        });
        
        // ============================================================================
        // AUTH STATE MANAGEMENT
        // ============================================================================
        
        async function handleAuthSuccess(privyResponse) {
            // Store tokens
            authState.accessToken = privyResponse.token || privyResponse.access_token;
            authState.user = privyResponse.user;
            authState.isAuthenticated = true;
            
            // Get embedded wallet address
            // Privy creates wallets automatically based on your app settings
            if (privyResponse.user?.wallet?.address) {
                authState.walletAddress = privyResponse.user.wallet.address;
            } else if (privyResponse.user?.linked_accounts) {
                // Find Solana wallet in linked accounts
                const solWallet = privyResponse.user.linked_accounts.find(
                    acc => acc.type === 'wallet' && acc.chain_type === 'solana'
                );
                if (solWallet) {
                    authState.walletAddress = solWallet.address;
                }
            }
            
            // Verify with our backend
            try {
                const backendResponse = await fetch(`${BACKEND_URL}/api/auth/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authState.accessToken}`
                    },
                    body: JSON.stringify({
                        wallet_address: authState.walletAddress
                    })
                });
                
                if (backendResponse.ok) {
                    const userData = await backendResponse.json();
                    console.log('Backend verified:', userData);
                }
            } catch (err) {
                console.error('Backend verification failed:', err);
            }
            
            // Update UI
            updateAuthUI();
            
            // Store in localStorage for session persistence
            localStorage.setItem('flappy_auth', JSON.stringify({
                accessToken: authState.accessToken,
                user: authState.user,
                walletAddress: authState.walletAddress
            }));
        }
        
        function updateAuthUI() {
            if (authState.isAuthenticated) {
                // Update auth button
                authButton.classList.add('logged-in');
                const displayName = authState.user?.email?.split('@')[0] || 
                                   authState.walletAddress?.slice(0, 6) + '...' ||
                                   'Connected';
                authButtonText.textContent = displayName;
                
                // Update dropdown
                document.getElementById('userDisplayName').textContent = displayName;
                document.getElementById('userWalletAddress').textContent = 
                    authState.walletAddress ? 
                    authState.walletAddress.slice(0, 8) + '...' + authState.walletAddress.slice(-6) : 
                    'No wallet';
                
                // Update wallet card
                walletNotConnected.style.display = 'none';
                walletConnected.style.display = 'flex';
                
                // Enable play button
                playButton.disabled = false;
                playButtonText.textContent = 'JOIN GAME';
                loginHint.style.display = 'none';
                
                // Update avatar
                document.getElementById('usernameAvatar').textContent = displayName[0].toUpperCase();
                
                // Set username if not set
                if (!usernameInput.value) {
                    usernameInput.value = displayName;
                }
            } else {
                authButton.classList.remove('logged-in');
                authButtonText.textContent = 'Sign Up / Login';
                
                walletNotConnected.style.display = 'flex';
                walletConnected.style.display = 'none';
                
                playButton.disabled = true;
                playButtonText.textContent = 'LOGIN TO PLAY';
                loginHint.style.display = 'block';
                
                document.getElementById('usernameAvatar').textContent = '?';
            }
        }
        
        function logout() {
            authState = {
                isAuthenticated: false,
                user: null,
                accessToken: null,
                walletAddress: null,
                walletBalance: 0,
                solBalance: 0
            };
            
            localStorage.removeItem('flappy_auth');
            updateAuthUI();
        }
        
        // Check for existing session on page load
        function checkExistingSession() {
            const stored = localStorage.getItem('flappy_auth');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    authState.accessToken = data.accessToken;
                    authState.user = data.user;
                    authState.walletAddress = data.walletAddress;
                    authState.isAuthenticated = true;
                    updateAuthUI();
                } catch (err) {
                    localStorage.removeItem('flappy_auth');
                }
            }
        }
        
        // ============================================================================
        // DEPOSIT & BETTING FUNCTIONS
        // ============================================================================
        
        async function depositAndJoinGame(betAmount) {
            if (!authState.isAuthenticated || !authState.walletAddress) {
                showPrivyModal();
                return false;
            }
            
            try {
                // For production with Privy embedded wallets, you'd use their SDK
                // to prompt the user to sign a transaction sending SOL to your house wallet
                
                // Example flow:
                // 1. Create transaction sending `betAmount` USD worth of SOL to house wallet
                // 2. Prompt user to sign via Privy SDK
                // 3. Submit transaction
                // 4. Send signature to backend for verification
                // 5. Backend credits user and lets them into game
                
                // For now, simulate the flow
                console.log(`Attempting to deposit $${betAmount} from ${authState.walletAddress}`);
                
                // In production:
                // const tx = await createDepositTransaction(betAmount);
                // const signedTx = await privy.signTransaction(tx);
                // const signature = await sendAndConfirmTransaction(signedTx);
                // await verifyDepositWithBackend(signature, betAmount);
                
                return true;
            } catch (err) {
                console.error('Deposit failed:', err);
                alert('Failed to process bet. Please try again.');
                return false;
            }
        }
        
        async function processCashout(sessionId, finalBalance) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/game/cashout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authState.accessToken}`
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        final_balance: finalBalance
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Cashout successful:', result);
                    return result;
                } else {
                    throw new Error('Cashout failed');
                }
            } catch (err) {
                console.error('Cashout error:', err);
                throw err;
            }
        }
        
        // ============================================================================
        // GAME CLIENT (Original code integrated)
        // ============================================================================
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const minimapCanvas = document.getElementById('minimapCanvas');
        const minimapCtx = minimapCanvas.getContext('2d');
        
        // All original game variables and functions here...
        // (truncated for brevity - keep all original game logic)
        
        const menuScreen = document.getElementById('menuScreen');
        const usernameInput = document.getElementById('usernameInput');
        const hud = document.getElementById('hud');
        const deathScreen = document.getElementById('deathScreen');
        const cashoutScreen = document.getElementById('cashoutScreen');
        const respawnButton = document.getElementById('respawnButton');
        const mainMenuButton = document.getElementById('mainMenuButton');
        const playAgainButton = document.getElementById('playAgainButton');
        const cashoutMenuButton = document.getElementById('cashoutMenuButton');
        const cashoutCloseButton = document.getElementById('cashoutCloseButton');
        const cashoutSpectateButton = document.getElementById('cashoutSpectateButton');
        const killerNameEl = document.getElementById('killerName');
        const killsValue = document.getElementById('killsValue');
        const balanceValue = document.getElementById('balanceValue');
        const playerCount = document.getElementById('playerCount');
        const healthBar = document.getElementById('healthBar');
        const healthValue = document.getElementById('healthValue');
        const boostBar = document.getElementById('boostBar');
        const boostValue = document.getElementById('boostValue');
        const leaderboardContent = document.getElementById('leaderboardContent');
        const killFeed = document.getElementById('killFeed');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const pauseIndicator = document.getElementById('pauseIndicator');
        const cashoutButton = document.getElementById('cashoutButton');
        const cashoutAmount = document.getElementById('cashoutAmount');
        const respawnAmount = document.getElementById('respawnAmount');
        const playAgainAmount = document.getElementById('playAgainAmount');
        const finalCashout = document.getElementById('finalCashout');
        const finalCashoutSol = document.getElementById('finalCashoutSol');
        const finalCashoutMini = document.getElementById('finalCashoutMini');
        const finalCashoutMiniSol = document.getElementById('finalCashoutMiniSol');
        const cashoutTimeSurvived = document.getElementById('cashoutTimeSurvived');
        const cashoutEliminations = document.getElementById('cashoutEliminations');
        const menuPlayersInGame = document.getElementById('menuPlayersInGame');
        const menuGlobalWinnings = document.getElementById('menuGlobalWinnings');
        const liveCashoutFeed = document.getElementById('liveCashoutFeed');
        const serverToggle = document.getElementById('serverToggle');
        const serverRegionText = document.getElementById('serverRegionText');
        
        // Server toggle
        let currentRegion = 'US';
        serverToggle.addEventListener('click', () => {
            currentRegion = currentRegion === 'US' ? 'EU' : 'US';
            serverRegionText.textContent = currentRegion;
            selectedRegion = currentRegion.toLowerCase();
            updateServerSelection(selectedBetAmount);
        });
        
        // Game state
        const BIRD_TYPES = ['yellow', 'blue', 'cloudyblue', 'orange', 'pink', 'purple', 'red', 'teal'];
        let ws = null;
        let myPlayerId = null;
        let config = {};
        let pipes = [];
        let serverZones = {};
        let players = new Map();
        let bullets = new Map();
        let orbs = new Map();
        let camera = { x: 0, y: 0 };
        let mousePos = { x: 0, y: 0 };
        let isShooting = false;
        let gameStarted = false;
        let connected = false;
        let currentBorderMargin = 200;
        let selectedServer = 'us-1';
        let selectedRegion = 'us';
        let selectedBetAmount = 1;
        let lastBetAmount = 1;
        let selectedBirdType = 'yellow';
        let keys = { space: false, shift: false, f: false };
        let isPaused = false;
        let zoomLevel = 2.0;
        const ZOOM_MIN = 1.0;
        const ZOOM_MAX = 2.0;
        const ZOOM_SPEED = 0.5;
        let targetZoom = zoomLevel;
        let matchStartTime = null;
        let spectateMode = false;
        let spectateTargetId = null;
        
        const sprites = { birds: {}, feathers: {}, map: {}, loaded: false, loadedCount: 0, totalCount: 0 };
        const clouds = [];
        const ANIMATION_FPS = 8;
        const FRAME_DURATION = 1000 / ANIMATION_FPS;
        let animationTime = 0;
        let lastAnimTime = Date.now();
        const birdContainer = document.getElementById('birdContainer');
        const birdElements = new Map();
        const playerAnimStates = new Map();
        
        // Load sprites
        function loadSprites() {
            const frameNames = ['fly_1.png', 'fly_2.png', 'fly_3.png', 'fire_1.png', 'fire_2.png', 'fire_3.png'];
            const mapSpriteNames = ['pipe.png', 'cloud_1.png', 'cloud_2.png'];
            sprites.totalCount = BIRD_TYPES.length * 6 + BIRD_TYPES.length + mapSpriteNames.length;
            
            BIRD_TYPES.forEach(birdType => {
                sprites.birds[birdType] = { fly: [], fire: [] };
                frameNames.forEach((file, index) => {
                    const img = new Image();
                    img.onload = () => { sprites.loadedCount++; checkAllLoaded(); };
                    img.onerror = () => { sprites.loadedCount++; checkAllLoaded(); };
                    img.src = `/assets/sprites/birds/${birdType}/${file}`;
                    if (index < 3) sprites.birds[birdType].fly[index] = img;
                    else sprites.birds[birdType].fire[index - 3] = img;
                });
            });
            
            BIRD_TYPES.forEach(birdType => {
                const img = new Image();
                img.onload = () => { sprites.loadedCount++; checkAllLoaded(); };
                img.onerror = () => { sprites.loadedCount++; checkAllLoaded(); };
                img.src = `/assets/sprites/feathers/${birdType}.png`;
                sprites.feathers[birdType] = img;
            });
            
            mapSpriteNames.forEach(file => {
                const img = new Image();
                const name = file.replace('.png', '');
                img.onload = () => { sprites.loadedCount++; checkAllLoaded(); };
                img.onerror = () => { sprites.loadedCount++; checkAllLoaded(); };
                img.src = `/assets/sprites/map/${file}`;
                sprites.map[name] = img;
            });
        }
        
        function checkAllLoaded() { if (sprites.loadedCount >= sprites.totalCount) sprites.loaded = true; }
        loadSprites();
        
        // Canvas resize
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; minimapCanvas.width = 130; minimapCanvas.height = 130; }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        // WebSocket connection
        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);
            ws.onopen = () => { connected = true; statusDot.classList.remove('disconnected'); statusText.textContent = 'Connected'; };
            ws.onclose = () => { connected = false; statusDot.classList.add('disconnected'); statusText.textContent = 'Disconnected'; setTimeout(connect, 2000); };
            ws.onerror = (err) => console.error('WebSocket error:', err);
            ws.onmessage = (event) => { try { handleServerMessage(JSON.parse(event.data)); } catch (e) { console.error('Failed to parse message:', e); } };
        }
        
        function handleServerMessage(message) {
            // ... (keep all original message handling code)
            switch (message.type) {
                case 'init':
                    myPlayerId = message.playerId;
                    config = message.config;
                    pipes = message.pipes || [];
                    serverZones = message.serverZones || {};
                    currentBorderMargin = message.currentBorderMargin || 200;
                    message.players.forEach(p => { players.set(p.id, { ...p, targetX: p.x, targetY: p.y, targetAngle: p.angle }); });
                    message.orbs.forEach(o => { orbs.set(o.id, { ...o, targetX: o.x, targetY: o.y }); });
                    break;
                case 'cashoutSuccess':
                    showCashoutScreen({
                        amountUsd: message.amountUsd,
                        amountLamports: message.amountLamports,
                        amountSol: message.amountSol
                    });
                    break;
                // ... (keep all other cases)
            }
        }
        
        // Bet buttons
        document.querySelectorAll('.bet-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                selectedBetAmount = parseInt(btn.dataset.amount);
                updateServerSelection(selectedBetAmount);
                document.querySelectorAll('.bet-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });
        
        function updateServerSelection(amount) {
            if (amount >= 20) selectedServer = `${selectedRegion}-20`;
            else if (amount >= 5) selectedServer = `${selectedRegion}-5`;
            else selectedServer = `${selectedRegion}-1`;
        }
        
        // Skin selection
        const skinPreview = document.getElementById('skinPreview');
        const skinPreviewImg = document.getElementById('skinPreviewImg');
        const skinModal = document.getElementById('skinModal');
        const skinModalClose = document.getElementById('skinModalClose');
        const skinGrid = document.getElementById('skinGrid');
        
        function populateSkinGrid() {
            skinGrid.innerHTML = '';
            BIRD_TYPES.forEach(birdType => {
                const option = document.createElement('div');
                option.className = 'skin-option' + (birdType === selectedBirdType ? ' selected' : '');
                option.dataset.bird = birdType;
                option.innerHTML = `<img src="/assets/sprites/birds/${birdType}/fly_1.png" alt="${birdType}">`;
                option.addEventListener('click', () => selectBird(birdType));
                skinGrid.appendChild(option);
            });
        }
        
        function selectBird(birdType) {
            selectedBirdType = birdType;
            document.querySelectorAll('.skin-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.bird === birdType);
            });
            skinModal.classList.remove('active');
        }
        
        let currentPreviewFrame = 0;
        const previewFrames = ['fly_1.png', 'fly_2.png', 'fly_3.png', 'fly_2.png'];
        setInterval(() => {
            if (skinPreviewImg && !gameStarted) {
                currentPreviewFrame = (currentPreviewFrame + 1) % previewFrames.length;
                skinPreviewImg.src = `/assets/sprites/birds/${selectedBirdType}/${previewFrames[currentPreviewFrame]}`;
            }
        }, 150);
        
        skinPreview.addEventListener('click', () => { populateSkinGrid(); skinModal.classList.add('active'); });
        skinModalClose.addEventListener('click', () => skinModal.classList.remove('active'));
        skinModal.addEventListener('click', (e) => { if (e.target === skinModal) skinModal.classList.remove('active'); });
        
        // Modified startGame to require auth
        async function startGame() {
            if (!authState.isAuthenticated) {
                showPrivyModal();
                return;
            }
            
            const name = usernameInput.value.trim() || 'Pilot';
            lastBetAmount = selectedBetAmount;
            
            // Process deposit first
            const depositSuccess = await depositAndJoinGame(lastBetAmount);
            if (!depositSuccess) {
                return;
            }
            
            isShooting = false;
            keys.space = keys.shift = keys.f = false;
            menuScreen.style.display = 'none';
            hud.style.display = 'block';
            gameStarted = true;
            matchStartTime = Date.now();
            spectateMode = false;
            spectateTargetId = null;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'setName', name: name }));
                ws.send(JSON.stringify({ type: 'joinGame', betAmount: lastBetAmount, serverId: selectedServer, birdType: selectedBirdType }));
            }
        }
        
        function respawn() {
            isShooting = false;
            keys.space = keys.shift = keys.f = false;
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'respawn', betAmount: lastBetAmount, birdType: selectedBirdType }));
            }
            deathScreen.style.display = 'none';
            cashoutScreen.style.display = 'none';
            matchStartTime = Date.now();
            spectateMode = false;
            spectateTargetId = null;
        }
        
        function goToMainMenu() {
            menuScreen.style.display = 'flex';
            hud.style.display = 'none';
            deathScreen.style.display = 'none';
            cashoutScreen.style.display = 'none';
            gameStarted = false;
            matchStartTime = null;
            spectateMode = false;
            spectateTargetId = null;
        }
        
        // Event listeners
        playButton.addEventListener('click', startGame);
        usernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') startGame(); });
        respawnButton.addEventListener('click', respawn);
        mainMenuButton.addEventListener('click', goToMainMenu);
        playAgainButton.addEventListener('click', respawn);
        cashoutMenuButton.addEventListener('click', goToMainMenu);
        if (cashoutCloseButton) cashoutCloseButton.addEventListener('click', goToMainMenu);
        if (cashoutSpectateButton) cashoutSpectateButton.addEventListener('click', () => {
            spectateMode = true;
            cashoutScreen.style.display = 'none';
            hud.style.display = 'none';
            menuScreen.style.display = 'none';
        });
        
        // Input handlers
        canvas.addEventListener('mousemove', (e) => { mousePos.x = e.clientX; mousePos.y = e.clientY; });
        canvas.addEventListener('mousedown', (e) => {
            mousePos.x = e.clientX;
            mousePos.y = e.clientY;
            if (e.button === 0) isShooting = true;
            if (e.button === 0) hudHandleMouseDown();
        });
        canvas.addEventListener('mouseup', (e) => {
            if (e.button === 0) isShooting = false;
            if (e.button === 0) hudHandleMouseUp();
        });
        canvas.addEventListener('contextmenu', (e) => e.preventDefault());
        
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') { keys.space = true; e.preventDefault(); }
            if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') keys.shift = true;
            if (e.code === 'KeyF') keys.f = true;
        });
        
        document.addEventListener('keyup', (e) => {
            if (e.code === 'Space') keys.space = false;
            if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') keys.shift = false;
            if (e.code === 'KeyF') keys.f = false;
        });
        
        // Utility functions
        function lerp(a, b, t) { return a + (b - a) * t; }
        function normalizeAngle(angle) { while (angle > Math.PI) angle -= Math.PI * 2; while (angle < -Math.PI) angle += Math.PI * 2; return angle; }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function formatSurvivalTime(ms) {
            const safeMs = Number.isFinite(ms) ? Math.max(0, ms) : 0;
            const totalSeconds = Math.floor(safeMs / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}m ${seconds}s`;
        }

        function applyCashoutCameraOverride() {
            if (cashoutScreen.style.display === 'flex') {
                if (config && Number.isFinite(config.worldWidth) && Number.isFinite(config.worldHeight)) {
                    camera.x = config.worldWidth / 2;
                    camera.y = config.worldHeight / 2;
                } else {
                    camera.x = 0;
                    camera.y = 0;
                }
                return;
            }

            if (spectateMode) {
                if (!spectateTargetId) {
                    const candidates = Array.from(players.values()).filter(p => p.id !== myPlayerId && p.alive);
                    spectateTargetId = candidates[0]?.id || null;
                }
                const target = spectateTargetId ? players.get(spectateTargetId) : null;
                if (target) {
                    camera.x = target.x;
                    camera.y = target.y;
                }
            }
        }

        function showCashoutScreen({ amountUsd = 0, amountLamports = 0, amountSol = null } = {}) {
            const usd = Number.isFinite(amountUsd) ? amountUsd : 0;
            const sol = Number.isFinite(amountSol)
                ? amountSol
                : (Number.isFinite(amountLamports) ? amountLamports / 1e9 : 0);
            finalCashout.textContent = usd.toFixed(2);
            if (finalCashoutMini) finalCashoutMini.textContent = usd.toFixed(2);
            if (finalCashoutSol) finalCashoutSol.textContent = sol.toFixed(6);
            if (finalCashoutMiniSol) finalCashoutMiniSol.textContent = sol.toFixed(6);
            if (cashoutTimeSurvived) {
                const elapsed = matchStartTime ? Date.now() - matchStartTime : 0;
                cashoutTimeSurvived.textContent = formatSurvivalTime(elapsed);
            }
            if (cashoutEliminations) {
                const localPlayer = players.get(myPlayerId);
                cashoutEliminations.textContent = localPlayer?.kills ?? 0;
            }
            deathScreen.style.display = 'none';
            cashoutScreen.style.display = 'flex';
            spectateMode = false;
            spectateTargetId = null;
        }

        // ============================================================================
        // CANVAS HUD (Menu-style replacements)
        // ============================================================================
        const HUD_FONT = '"Inter Bold", "Inter", "Segoe UI", Arial, sans-serif';
        const HUD_COLORS = {
            panelTop: "#171717",
            panelBottom: "#0f0f0f",
            panelEdge: "#2a2a2a",
            panelGlow: "rgba(255,255,255,0.06)",
            textWhite: "#f5f5f5",
            textMuted: "#8b8b8b",
            green: "#2bd96b",
            yellow: "#ffd54a",
            yellowEdge: "#b8930a",
            yellowDark: "#1b1b1b",
            shadowDark: "#0a0a0a",
            radarRing: "#5a1014",
            radarRingInner: "#8b1a1f"
        };
        const hudState = {
            cashout: { hover: false, pressed: false },
            cashoutRect: null,
            radarDots: new Map(),
            moneyTags: new Map()
        };
        const hudNumberFormat = new Intl.NumberFormat("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        function hudFormatUsd(value) {
            const amount = typeof value === "number" && Number.isFinite(value) ? value : 0;
            return hudNumberFormat.format(amount);
        }

        function hudGetScale() {
            const scale = Math.min(canvas.width / 1280, canvas.height / 720);
            return Math.max(0.8, Math.min(1.2, scale));
        }

        function hudRoundRectPath(ctx, x, y, w, h, r) {
            const radius = Math.min(r, w / 2, h / 2);
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + w - radius, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + radius);
            ctx.lineTo(x + w, y + h - radius);
            ctx.quadraticCurveTo(x + w, y + h, x + w - radius, y + h);
            ctx.lineTo(x + radius, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        function hudFillRoundedRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            hudRoundRectPath(ctx, x, y, w, h, r);
            ctx.fill();
        }

        function hudStrokeRoundedRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            hudRoundRectPath(ctx, x, y, w, h, r);
            ctx.stroke();
        }

        function hudDrawPanel(ctx, rect, scale) {
            const shadowOffset = 3 * scale;
            ctx.save();
            ctx.fillStyle = HUD_COLORS.shadowDark;
            hudFillRoundedRect(ctx, rect.x, rect.y + shadowOffset, rect.w, rect.h, rect.r);
            const gradient = ctx.createLinearGradient(rect.x, rect.y, rect.x, rect.y + rect.h);
            gradient.addColorStop(0, HUD_COLORS.panelTop);
            gradient.addColorStop(1, HUD_COLORS.panelBottom);
            ctx.fillStyle = gradient;
            hudFillRoundedRect(ctx, rect.x, rect.y, rect.w, rect.h, rect.r);
            ctx.strokeStyle = HUD_COLORS.panelEdge;
            ctx.lineWidth = Math.max(1, Math.round(1.5 * scale));
            hudStrokeRoundedRect(ctx, rect.x, rect.y, rect.w, rect.h, rect.r);
            ctx.fillStyle = HUD_COLORS.panelGlow;
            hudFillRoundedRect(ctx, rect.x + 6 * scale, rect.y + 6 * scale, rect.w - 12 * scale, 10 * scale, rect.r);
            ctx.restore();
        }

        function hudDrawButton(ctx, rect, label, state, scale) {
            const baseShadow = 4 * scale;
            const hoverOffset = state.hover ? 4 * scale : 0;
            const pressOffset = state.pressed ? 2 * scale : 0;
            const offset = hoverOffset + pressOffset;
            const shadowDepth = Math.max(1 * scale, baseShadow - offset * 0.6);

            ctx.save();
            ctx.fillStyle = "#7a5e08";
            hudFillRoundedRect(ctx, rect.x, rect.y + offset + shadowDepth, rect.w, rect.h, rect.r);

            const gradient = ctx.createLinearGradient(rect.x, rect.y + offset, rect.x, rect.y + rect.h + offset);
            gradient.addColorStop(0, "#ffe06a");
            gradient.addColorStop(1, "#e6b800");
            ctx.fillStyle = gradient;
            hudFillRoundedRect(ctx, rect.x, rect.y + offset, rect.w, rect.h, rect.r);
            ctx.strokeStyle = HUD_COLORS.yellowEdge;
            ctx.lineWidth = Math.max(1, Math.round(1.5 * scale));
            hudStrokeRoundedRect(ctx, rect.x, rect.y + offset, rect.w, rect.h, rect.r);

            ctx.fillStyle = "rgba(255,255,255,0.18)";
            hudFillRoundedRect(ctx, rect.x + 6 * scale, rect.y + offset + 6 * scale, rect.w - 12 * scale, 8 * scale, rect.r);

            ctx.fillStyle = HUD_COLORS.yellowDark;
            ctx.font = `${Math.round(16 * scale)}px ${HUD_FONT}`;
            ctx.textBaseline = "middle";
            ctx.textAlign = "center";
            ctx.fillText(label, rect.x + rect.w / 2, rect.y + offset + rect.h / 2);
            ctx.restore();
        }

        function hudDrawLeaderboard(ctx, rect, scale, playersArray, localId) {
            hudDrawPanel(ctx, rect, scale);
            const headerY = rect.y + 14 * scale;
            ctx.save();
            ctx.fillStyle = HUD_COLORS.textWhite;
            ctx.font = `${Math.round(14 * scale)}px ${HUD_FONT}`;
            ctx.textBaseline = "alphabetic";
            ctx.textAlign = "left";
            ctx.fillText("LEADERBOARD", rect.x + 14 * scale, headerY + 10 * scale);

            ctx.fillStyle = HUD_COLORS.panelEdge;
            ctx.fillRect(rect.x + 12 * scale, rect.y + 32 * scale, rect.w - 24 * scale, Math.max(1, Math.round(scale)));

            const maxRows = 8;
            const rowHeight = 20 * scale;
            const startY = rect.y + 46 * scale;
            const sorted = playersArray
                .slice()
                .sort((a, b) => (b.balance || 0) - (a.balance || 0))
                .slice(0, maxRows);

            sorted.forEach((player, index) => {
                const rowY = startY + index * rowHeight;
                const isSelf = player.id === localId;
                if (isSelf) {
                    ctx.fillStyle = "#2a2414";
                    hudFillRoundedRect(ctx, rect.x + 8 * scale, rowY - 6 * scale, rect.w - 16 * scale, rowHeight, 6 * scale);
                    ctx.strokeStyle = HUD_COLORS.yellowEdge;
                    ctx.lineWidth = Math.max(1, Math.round(1 * scale));
                    hudStrokeRoundedRect(ctx, rect.x + 8 * scale, rowY - 6 * scale, rect.w - 16 * scale, rowHeight, 6 * scale);
                }
                ctx.fillStyle = HUD_COLORS.textMuted;
                ctx.font = `${Math.round(12 * scale)}px ${HUD_FONT}`;
                ctx.textAlign = "left";
                ctx.fillText(`${index + 1}.`, rect.x + 14 * scale, rowY + 8 * scale);

                ctx.fillStyle = HUD_COLORS.textWhite;
                ctx.font = `${Math.round(12 * scale)}px ${HUD_FONT}`;
                const name = player.name || "Player";
                ctx.fillText(name, rect.x + 40 * scale, rowY + 8 * scale);

                ctx.fillStyle = HUD_COLORS.green;
                ctx.textAlign = "right";
                ctx.font = `${Math.round(12 * scale)}px ${HUD_FONT}`;
                ctx.fillText(`$${hudFormatUsd(player.balance)}`, rect.x + rect.w - 14 * scale, rowY + 8 * scale);
            });

            ctx.fillStyle = HUD_COLORS.textMuted;
            ctx.textAlign = "center";
            ctx.font = `${Math.round(11 * scale)}px ${HUD_FONT}`;
            ctx.fillText(`${playersArray.length} players online`, rect.x + rect.w / 2, rect.y + rect.h - 10 * scale);
            ctx.restore();
        }

        function hudDrawRadar(ctx, rect, scale, playersArray, localPlayer, cfg) {
            hudDrawPanel(ctx, rect, scale);
            const padding = 12 * scale;
            const radius = Math.min(rect.w, rect.h) / 2 - padding;
            const centerX = rect.x + rect.w / 2;
            const centerY = rect.y + rect.h / 2 + 2 * scale;

            ctx.save();
            ctx.fillStyle = "#0b0b0b";
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = HUD_COLORS.radarRing;
            ctx.lineWidth = Math.max(1, Math.round(2 * scale));
            ctx.stroke();
            ctx.strokeStyle = HUD_COLORS.radarRingInner;
            ctx.lineWidth = Math.max(1, Math.round(1 * scale));
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius - 4 * scale, 0, Math.PI * 2);
            ctx.stroke();

            if (localPlayer) {
                const radarRange = cfg && cfg.WORLD_WIDTH ? Math.min(cfg.WORLD_WIDTH, cfg.WORLD_HEIGHT) / 2 : 1400;
                playersArray.forEach((player) => {
                    if (!player.alive) return;
                    const dx = player.x - localPlayer.x;
                    const dy = player.y - localPlayer.y;
                    const dist = Math.hypot(dx, dy);
                    const clamped = Math.min(dist, radarRange);
                    const t = radarRange > 0 ? clamped / radarRange : 0;
                    const nx = dist > 0 ? dx / dist : 0;
                    const ny = dist > 0 ? dy / dist : 0;
                    const targetX = centerX + nx * t * radius;
                    const targetY = centerY + ny * t * radius;
                    const prev = hudState.radarDots.get(player.id);
                    const smoothX = prev ? lerp(prev.x, targetX, 0.2) : targetX;
                    const smoothY = prev ? lerp(prev.y, targetY, 0.2) : targetY;
                    hudState.radarDots.set(player.id, { x: smoothX, y: smoothY });
                    ctx.fillStyle = player.id === localPlayer.id ? HUD_COLORS.yellow : "#d8e3ff";
                    ctx.beginPath();
                    ctx.arc(smoothX, smoothY, 2.2 * scale, 0, Math.PI * 2);
                    ctx.fill();
                });
            }
            ctx.restore();
        }

        function hudWorldToScreen(x, y) {
            return {
                x: (x - camera.x) * zoomLevel + canvas.width / 2,
                y: (y - camera.y) * zoomLevel + canvas.height / 2
            };
        }

        function hudDrawMoneyTags(ctx, scale, playersArray) {
            const localScale = Math.max(0.7, Math.min(1.6, zoomLevel));
            const baseWidth = 52 * localScale;
            const baseHeight = 26 * localScale;
            const radius = 10 * localScale;
            const worldOffset = (config && config.PLAYER_SIZE ? config.PLAYER_SIZE : 25) * 1.8;
            playersArray.forEach((player) => {
                if (!player.alive) return;
                const screen = hudWorldToScreen(player.x, player.y - worldOffset);
                const target = { x: screen.x, y: screen.y };
                const prev = hudState.moneyTags.get(player.id);
                const smoothX = prev ? lerp(prev.x, target.x, 0.2) : target.x;
                const smoothY = prev ? lerp(prev.y, target.y, 0.2) : target.y;
                hudState.moneyTags.set(player.id, { x: smoothX, y: smoothY });
                const rectX = smoothX - baseWidth / 2;
                const rectY = smoothY - baseHeight / 2;
                ctx.save();
                ctx.fillStyle = "#121212";
                hudFillRoundedRect(ctx, rectX, rectY, baseWidth, baseHeight, radius);
                ctx.strokeStyle = HUD_COLORS.yellowEdge;
                ctx.lineWidth = Math.max(1, Math.round(1.2 * localScale));
                hudStrokeRoundedRect(ctx, rectX, rectY, baseWidth, baseHeight, radius);
                ctx.fillStyle = HUD_COLORS.green;
                ctx.font = `${Math.round(12 * localScale)}px ${HUD_FONT}`;
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(`$${hudFormatUsd(player.balance)}`, smoothX, smoothY + 0.5 * localScale);
                ctx.restore();
            });
        }

        function drawHud() {
            if (!gameStarted || deathScreen.style.display === 'flex' || cashoutScreen.style.display === 'flex') return;
            const scale = hudGetScale();
            const margin = 18 * scale;
            const leaderboardRect = {
                x: canvas.width - margin - 210 * scale,
                y: margin,
                w: 210 * scale,
                h: 236 * scale,
                r: 10 * scale
            };
            const radarRect = {
                x: leaderboardRect.x,
                y: leaderboardRect.y + leaderboardRect.h + 12 * scale,
                w: leaderboardRect.w,
                h: 150 * scale,
                r: 10 * scale
            };
            const cashoutRect = {
                x: (canvas.width - 210 * scale) / 2,
                y: canvas.height - margin - 52 * scale,
                w: 210 * scale,
                h: 52 * scale,
                r: 10 * scale
            };
            hudState.cashoutRect = cashoutRect;
            hudState.cashout.hover = mousePos.x >= cashoutRect.x &&
                mousePos.x <= cashoutRect.x + cashoutRect.w &&
                mousePos.y >= cashoutRect.y &&
                mousePos.y <= cashoutRect.y + cashoutRect.h;

            const playersArray = Array.from(players.values()).filter((player) => player.joined);
            const localPlayer = players.get(myPlayerId);
            const idSet = new Set(playersArray.map((player) => player.id));
            hudState.radarDots.forEach((_, id) => { if (!idSet.has(id)) hudState.radarDots.delete(id); });
            hudState.moneyTags.forEach((_, id) => { if (!idSet.has(id)) hudState.moneyTags.delete(id); });

            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            hudDrawLeaderboard(ctx, leaderboardRect, scale, playersArray, myPlayerId);
            hudDrawRadar(ctx, radarRect, scale, playersArray, localPlayer, config);
            const cashoutValue = localPlayer ? localPlayer.balance : 0;
            hudDrawButton(ctx, cashoutRect, `CASH OUT $${hudFormatUsd(cashoutValue)}`, hudState.cashout, scale);
            hudDrawMoneyTags(ctx, scale, playersArray);
            ctx.restore();
        }

        function hudHandleMouseDown() {
            if (!gameStarted || !hudState.cashoutRect) return;
            if (hudState.cashout.hover) {
                hudState.cashout.pressed = true;
            }
        }

        function hudHandleMouseUp() {
            if (hudState.cashout.pressed && hudState.cashout.hover && cashoutButton) {
                cashoutButton.click();
            }
            hudState.cashout.pressed = false;
        }

        // Simplified render loop
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            applyCashoutCameraOverride();
            // ... (keep original render logic)
            drawHud();
            requestAnimationFrame(render);
        }
        
        // Initialize
        checkExistingSession();
        connect();
        render();
        
        console.log('Flappy.one initialized with Privy authentication');
    </script>
</body>
</html>
